# ============================================
# COMMON CONFIGURATION TEMPLATES
# ============================================
# Template services for docker-compose extends
# These services are not meant to run directly

services:
  # ============================================
  # BASE TEMPLATES
  # ============================================
  
  # Network configuration base
  network-base:
    networks:
      - ecommerce-network

  # Infrastructure service base
  infra-service-base:
    extends:
      service: network-base
    restart: unless-stopped
    
  # ============================================
  # MICROSERVICE TEMPLATES
  # ============================================

  # Basic microservice with all infrastructure dependencies
  microservice-base:
    extends:
      service: network-base
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      # Database
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      # Service Discovery & Config
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: ${EUREKA_URL}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      CONFIG_SERVER_URL: ${CONFIG_SERVER_URL}
      # Messaging
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      
  # Microservice with Redis cache
  microservice-with-redis:
    extends:
      service: microservice-base
    environment:
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      SPRING_DATA_REDIS_DATABASE: ${REDIS_DATABASE}

  # Microservice with JWT authentication
  microservice-with-jwt:
    extends:
      service: microservice-base
    environment:
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_ALGORITHM: ${JWT_ALGORITHM}

  # Microservice with Redis and JWT (User Service pattern)
  microservice-with-redis-jwt:
    extends:
      service: microservice-base
    environment:
      # Redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      SPRING_DATA_REDIS_DATABASE: ${REDIS_DATABASE}
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_ALGORITHM: ${JWT_ALGORITHM}

  # ============================================
  # GATEWAY/CONFIG TEMPLATES
  # ============================================

  # Config server base
  config-server-base:
    extends:
      service: network-base
    depends_on:
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: ${EUREKA_URL}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}

  # API Gateway base
  gateway-base:
    extends:
      service: network-base
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Service Discovery
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: ${EUREKA_URL}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      # Redis Configuration (for token blacklist)
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DATABASE: ${REDIS_DATABASE}
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER}
      # Token Blacklist
      TOKEN_BLACKLIST_PREFIX: ${TOKEN_BLACKLIST_PREFIX}

# Define the shared network
networks:
  ecommerce-network:
    driver: bridge
